---
/**
 * Programmatic Bonus Pages
 * Dynamic route that generates individual bonus information pages
 * from Markdown content collections
 * 
 * SEO Benefits:
 * - Zero JavaScript (fully static)
 * - Individual pages for each bonus type
 * - Scalable (hundreds of pages from single template)
 * - Crawl-friendly HTML
 */

import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import SEOComplete from '../../components/seo/SEOComplete.astro';
import Breadcrumbs from '../../components/seo/Breadcrumbs.astro';
import AuthorBox from '../../components/seo/AuthorBox.astro';
import FreshnessIndicator from '../../components/seo/FreshnessIndicator.astro';
import RelatedLinks from '../../components/seo/RelatedLinks.astro';
import { generateFAQSchema, generateArticleSchema, generateBreadcrumbSchema } from '../../utils/seo/generateSchema';

// Generate static paths for all bonuses
export async function getStaticPaths() {
  const bonuses = await getCollection('bonuses');
  
  return bonuses.map((bonus) => ({
    params: { slug: bonus.slug },
    props: { bonus }
  }));
}

interface Props {
  bonus: CollectionEntry<'bonuses'>;
}

const { bonus } = Astro.props;
const { Content } = await bonus.render();

// Lifecycle Management (Kill-Switch)
const isRetired = bonus.data.lifecycleStatus === 'retired' || bonus.data.lifecycleStatus === 'archived';
const isUnderReview = bonus.data.lifecycleStatus === 'under-review';

// Selective indexing (lifecycle + shouldIndex combined)
let robotsContent = 'index, follow';
if (isRetired || !bonus.data.shouldIndex) {
  robotsContent = 'noindex, follow';
}

// Content angle customization (variation for deduplication)
const angleConfig = {
  'beginner-guide': { headerClass: 'beginner-focused', introStyle: 'step-by-step' },
  'risk-analysis': { headerClass: 'risk-focused', introStyle: 'warning-first' },
  'comparison-focused': { headerClass: 'comparison-focused', introStyle: 'table-driven' },
  'expert-deep-dive': { headerClass: 'expert-focused', introStyle: 'technical' },
  'quick-reference': { headerClass: 'quick-ref', introStyle: 'scannable' }
};

const currentAngle = angleConfig[bonus.data.contentAngle] || angleConfig['beginner-guide'];

// E-E-A-T Author data
const author = bonus.data.author || {
  name: 'Maxwin580 Editöryal Ekibi',
  slug: 'editorial-team',
  title: 'Editorial Team',
  experience: 'Sektör uzmanları'
};

// Content Freshness dates (with fallback to current date)
const now = new Date();
const publishedAt = bonus.data.publishedAt || bonus.data.updatedAt || now;
const updatedAt = bonus.data.updatedAt || now;
const reviewedBy = bonus.data.reviewedBy || author.name;

// Internal Link Throttling
const parentHub = bonus.data.parentHub || '/bonuses';
const relatedPages = bonus.data.relatedPages || [];

// Breadcrumb navigation
const breadcrumbs = [
  { name: 'Ana Sayfa', url: '/' },
  { name: 'Bonus Bilgileri', url: '/bonuses' },
  { name: bonus.data.title, url: `/bonuses/${bonus.slug}` }
];

// Generate schemas with proper freshness signals
const articleSchema = generateArticleSchema({
  headline: bonus.data.title,
  description: bonus.data.description,
  datePublished: publishedAt.toISOString(),
  dateModified: updatedAt.toISOString(),
  author: author.name
});

const breadcrumbSchema = generateBreadcrumbSchema(breadcrumbs);

// Risk level display
const riskColors = {
  low: '#28a745',
  medium: '#ffc107',
  high: '#dc3545'
};

const riskLabels = {
  low: 'Düşük Risk',
  medium: 'Orta Risk',
  high: 'Yüksek Risk'
};
---

<BaseLayout>
  <SEOComplete
    slot="head"
    title={bonus.data.title}
    description={bonus.data.description}
    keywords={bonus.data.keywords}
    ogType="article"
    ogImage={`/assets/images/bonuses/${bonus.slug}-og.jpg`}
    schema={[articleSchema, breadcrumbSchema]}
    article={{
      publishedTime: publishedAt.toISOString(),
      modifiedTime: updatedAt.toISOString(),
      section: 'Bonus Bilgileri',
      tags: [bonus.data.bonusType, 'bonus', 'casino']
    }}
  />
  
  <!-- Selective indexing for thin content prevention -->
  <meta slot="head" name="robots" content={robotsContent} />

  <Breadcrumbs items={breadcrumbs} />

  <article class={`bonus-page ${currentAngle.headerClass}`}>
    <!-- Header Section -->
    <header class="bonus-header">
      <h1>{bonus.data.title}</h1>
      <p class="lead">{bonus.data.description}</p>
      
      <div class="bonus-meta">
        <span class="bonus-type">{bonus.data.bonusType}</span>
        {bonus.data.riskLevel && (
          <span class="risk-badge" style={`background-color: ${riskColors[bonus.data.riskLevel]}`}>
            {riskLabels[bonus.data.riskLevel]}
          </span>
        )}
      </div>
    </header>
    
    <!-- Content Freshness Indicator (SEO Signal) -->
    <FreshnessIndicator 
      publishedAt={publishedAt}
      updatedAt={updatedAt}
      reviewedBy={reviewedBy}
      contentVersion={bonus.data.contentVersion}
    />

    <!-- Quick Info Box -->
    <aside class="quick-info">
      <h2>Hızlı Bilgiler</h2>
      <dl>
        <dt>Bonus Türü:</dt>
        <dd>{bonus.data.bonusType}</dd>
        
        <dt>Çevrim Şartı:</dt>
        <dd>{bonus.data.wagering}</dd>
        
        {bonus.data.riskLevel && (
          <>
            <dt>Risk Seviyesi:</dt>
            <dd style={`color: ${riskColors[bonus.data.riskLevel]}`}>
              {riskLabels[bonus.data.riskLevel]}
            </dd>
          </>
        )}
        
        <dt>Bölgeler:</dt>
        <dd>{bonus.data.geo.join(', ')}</dd>
      </dl>
    </aside>

    <!-- Main Content (from Markdown) -->
    <div class="bonus-content">
      <Content />
    </div>

    <!-- Pros & Cons -->
    <section class="pros-cons">
      <div class="pros">
        <h2>Avantajlar</h2>
        <ul>
          {bonus.data.pros.map(pro => <li>{pro}</li>)}
        </ul>
      </div>

      <div class="cons">
        <h2>Dezavantajlar</h2>
        <ul>
          {bonus.data.cons.map(con => <li>{con}</li>)}
        </ul>
      </div>
    </section>

    <!-- Suitability Section -->
    <section class="suitability">
      <div class="suitable">
        <h2>Kimler İçin Uygun Olabilir</h2>
        <ul>
          {(bonus.data.suitableFor || []).map(item => <li>{item}</li>)}
        </ul>
      </div>

      <div class="not-suitable">
        <h2>Kimler İçin Uygun Olmayabilir</h2>
        <ul>
          {(bonus.data.notSuitableFor || []).map(item => <li>{item}</li>)}
        </ul>
      </div>
    </section>

    <!-- Responsible Gambling Reminder -->
    <section class="responsible-gaming-reminder">
      <h2>Sorumlu Oyun Hatırlatması</h2>
      <p>
        Bu bonus bilgileri yalnızca eğitim amaçlıdır. Bonuslar eğlence içindir ve 
        kazanç garantisi yoktur. Çevrim şartları tamamlanmayabilir.
      </p>
      <p>
        Lütfen <a href="/sorumlu-oyun">sorumlu oyun kurallarına</a> uyun. 
        18+ yaş sınırı geçerlidir.
      </p>
      <ul>
        <li>Sadece kaybetmeyi göze alabileceğiniz tutarlarla oynayın</li>
        <li>Limit araçlarını kullanın (yatırım, kayıp, süre limitleri)</li>
        <li>Bonusu gelir kaynağı olarak görmeyin</li>
        <li>Kumar bağımlılığı için yardım alın: <a href="/sorumlu-oyun">Destek Kaynakları</a></li>
      </ul>
    </section>

    <!-- E-E-A-T Author Box (Trust Layer) -->
    <AuthorBox 
      name={author.name}
      slug={author.slug}
      title={author.title}
      experience={author.experience}
    />

    <!-- Related Links (Internal Link Throttling - max 5 contextual links) -->
    <RelatedLinks 
      parentHub={parentHub}
      parentHubLabel="Tüm Bonus Rehberleri"
      relatedPages={relatedPages}
      showCompliance={true}
    />

    <!-- Legal Disclaimer -->
    <footer class="legal-disclaimer">
      <p>
        <strong>Yasal Uyarı:</strong> Bu içerik yalnızca bilgilendirme amaçlıdır ve 
        bonus kullanımını teşvik etmez. Bonuslar risk içerir ve çevrim şartları 
        tamamlanmayabilir. 18+ yaş sınırı geçerlidir. Lütfen sorumlu bir şekilde oynayın.
      </p>
    </footer>
  </article>
</BaseLayout>

<style>
  .bonus-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .bonus-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 30px;
    border-bottom: 2px solid #e0e0e0;
  }

  .bonus-header h1 {
    font-size: clamp(28px, 5vw, 42px);
    margin-bottom: 16px;
    color: #1a1a1a;
  }

  .lead {
    font-size: 18px;
    color: #666;
    max-width: 700px;
    margin: 0 auto 24px;
    line-height: 1.6;
  }

  .bonus-meta {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
    font-size: 14px;
  }

  .bonus-type {
    background: #f0f0f0;
    padding: 6px 16px;
    border-radius: 20px;
    font-weight: 500;
    text-transform: capitalize;
  }

  .risk-badge {
    color: white;
    padding: 6px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 13px;
  }

  .quick-info {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 24px;
    margin-bottom: 40px;
    border-radius: 8px;
  }

  .quick-info h2 {
    margin-top: 0;
    font-size: 20px;
    margin-bottom: 16px;
  }

  .quick-info dl {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 12px 16px;
    margin: 0;
  }

  .quick-info dt {
    font-weight: 600;
    color: #333;
  }

  .quick-info dd {
    margin: 0;
    color: #666;
  }

  .bonus-content {
    margin-bottom: 48px;
    line-height: 1.8;
  }

  .bonus-content h2 {
    font-size: 28px;
    margin: 40px 0 20px;
    color: #1a1a1a;
  }

  .bonus-content h3 {
    font-size: 22px;
    margin: 32px 0 16px;
    color: #333;
  }

  .pros-cons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 48px;
  }

  .pros, .cons {
    padding: 24px;
    border-radius: 12px;
  }

  .pros {
    background: #e8f5e9;
    border: 2px solid #4caf50;
  }

  .cons {
    background: #ffebee;
    border: 2px solid #f44336;
  }

  .pros h2, .cons h2 {
    font-size: 20px;
    margin-top: 0;
    margin-bottom: 16px;
  }

  .pros ul, .cons ul {
    margin: 0;
    padding-left: 20px;
  }

  .pros li, .cons li {
    margin-bottom: 10px;
  }

  .suitability {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 48px;
    padding: 30px;
    background: #f5f5f5;
    border-radius: 12px;
  }

  .suitability h2 {
    font-size: 20px;
    margin-top: 0;
    margin-bottom: 16px;
  }

  .suitability ul {
    margin: 0;
    padding-left: 20px;
  }

  .suitability li {
    margin-bottom: 10px;
  }

  .responsible-gaming-reminder {
    background: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 48px;
  }

  .responsible-gaming-reminder h2 {
    margin-top: 0;
    color: #856404;
    font-size: 22px;
  }

  .responsible-gaming-reminder a {
    color: #856404;
    font-weight: 600;
    text-decoration: underline;
  }

  .responsible-gaming-reminder ul {
    margin-top: 16px;
  }

  .related-bonuses {
    margin-bottom: 48px;
  }

  .related-bonuses h2 {
    font-size: 22px;
    margin-bottom: 16px;
  }

  .related-bonuses ul {
    list-style: none;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .related-bonuses li {
    background: #f0f0f0;
    border-radius: 8px;
  }

  .related-bonuses a {
    display: block;
    padding: 12px 20px;
    color: #333;
    text-decoration: none;
    transition: all 0.3s;
  }

  .related-bonuses a:hover {
    background: #007bff;
    color: white;
  }

  .legal-disclaimer {
    background: #f8f9fa;
    border-top: 3px solid #dc3545;
    padding: 24px;
    border-radius: 8px;
    font-size: 14px;
    color: #666;
  }

  .legal-disclaimer strong {
    color: #dc3545;
  }

  @media (max-width: 768px) {
    .bonus-meta {
      flex-direction: column;
      align-items: flex-start;
    }

    .quick-info dl {
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .quick-info dt::after {
      content: '';
    }

    .pros-cons, .suitability {
      grid-template-columns: 1fr;
    }
  }
</style>
```

